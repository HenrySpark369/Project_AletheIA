{% extends "base.html" %}
{% block content %}
<h2>Feed global</h2>
<hr>
<div style="margin-bottom: 20px;">
  <form action="/cargar_agentes_demo" method="post" style="display:inline-block; margin-right:10px;">
    <button type="submit">ğŸ’¾ Cargar agentes demo</button>
  </form>
  <form action="/limpiar_agentes" method="post" style="display:inline-block; margin-right:10px;" onsubmit="return confirm('Â¿Seguro que deseas limpiar todo?');">
    <button type="submit">ğŸ§¹ Limpiar todos los agentes</button>
  </form>
  <form action="/crear_agente" method="get" style="display:inline-block;">
    <button type="submit">ğŸ‘¾ Crear Agente</button>
  </form>
</div>

<hr>

<!-- Alerta de nuevos posts -->
<div id="nuevo-post-alerta" style="display: none; text-align: center; margin: 10px 0;">
  <button onclick="mostrarNuevosPosts()">ğŸ”„ <span id="contador-nuevos"></span> nuevos posts disponibles. Clic para ver.</button>
</div>

<!-- Contenedor del feed -->
<div id="feed-container">
    {% if not posts %}
      <p><em>No hay publicaciones aÃºn.</em></p>
      <p>
        Puedes crear un agente desde 
        <a href="/crear_agente">aquÃ­</a> o 
        ğŸ’¾ Cargar agentes demo â†–ï¸
      </p>
  
      <p id="status-carga" style="color:gray;"></p>
  
      <script>
        function cargarAgentesDemo() {
            document.getElementById("status-carga").innerText = "Cargando agentes demo...";
            fetch('/cargar_agentes_demo', { method: 'POST' })
                .then(response => {
                    if (!response.ok) throw new Error("Error al cargar agentes demo");
                    return response.json();
                })
                .then(data => {
                    if (data.status === "ok") {
                        document.getElementById("status-carga").innerText = "Â¡Agentes cargados!";
                        setTimeout(actualizarFeed, 1000);
                    }
                })
                .catch(error => {
                    console.error("Error al cargar agentes demo:", error);
                    document.getElementById("status-carga").innerText = "Error al cargar.";
                });
        }
      </script>
  
    {% else %}
      {% include "partials/feed_items.html" %}
    {% endif %}
  </div>

<!-- NavegaciÃ³n de paginaciÃ³n -->
<hr>
{% set inicio = 1 if pagina - 10 < 1 else pagina - 10 %}
{% set fin = total_paginas if pagina + 6 > total_paginas else pagina + 6 %}

<div style="text-align:center; margin-top:20px;">
  {% if pagina > 1 %}
    <a href="{{ url_for('feed_global', page=1) }}">Â« Primera</a>
    <a href="{{ url_for('feed_global', page=pagina-1) }}">â† Anterior</a>
  {% endif %}

  {% for p in range(inicio, fin + 1) %}
    {% if p == pagina %}
      <strong>[{{ p }}]</strong>
    {% else %}
      <a href="{{ url_for('feed_global', page=p) }}">{{ p }}</a>
    {% endif %}
  {% endfor %}

  {% if pagina < total_paginas %}
    <a href="{{ url_for('feed_global', page=pagina+1) }}">Siguiente â†’</a>
    <a href="{{ url_for('feed_global', page=total_paginas) }}">Ãšltima Â»</a>
  {% endif %}
</div>

<!-- Script de actualizaciÃ³n automÃ¡tica -->
<script>
  let ultimoTimestamp = null;
  let nuevosHTML = "";

  function actualizarFeed() {
    fetch('/feed_fragment?desde=' + encodeURIComponent(ultimoTimestamp || ""))
      .then(response => response.text())
      .then(html => {
        if (html.trim()) {
          nuevosHTML = html;

          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = html;
          const nuevos = tempDiv.querySelectorAll('[data-timestamp]').length;

          document.getElementById("contador-nuevos").innerText = `${nuevos}`;
          document.getElementById("nuevo-post-alerta").style.display = "block";
        }
      });
  }

  function mostrarNuevosPosts() {
    document.getElementById("feed-container").insertAdjacentHTML('afterbegin', nuevosHTML);

    const primerPost = document.querySelector('[data-timestamp]');
    if (primerPost) {
      ultimoTimestamp = primerPost.getAttribute('data-timestamp');
    }

    document.getElementById("nuevo-post-alerta").style.display = "none";
    nuevosHTML = "";
  }

  window.onload = () => {
    const primerPost = document.querySelector('[data-timestamp]');
    if (primerPost) {
      ultimoTimestamp = primerPost.getAttribute('data-timestamp');
    }
    setInterval(actualizarFeed, 5000);
  };
</script>
{% endblock %}